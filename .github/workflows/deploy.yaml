name: Deploy
on:
  push:
    branches:
      - main
      - master
    paths:
      - 'src/**'
      - 'prisma/**'
      - 'prisma.config.ts'
      - 'package.json'
      - 'package-lock.json'
      - 'Dockerfile'
      - 'ops/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.2

      - name: Backup current deployment on VPS
        uses: appleboy/ssh-action@v1.2.5
        with:
          host: ${{ secrets.HOSTNAME }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_path: ./scripts/backup-ops.sh
          envs: REMOTE_USER
        env:
          REMOTE_USER: ${{ secrets.REMOTE_USER }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3.7.0
        with:
          username: ${{ vars.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3.7.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3.12.0

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v6.19.2
        with:
          context: .
          push: true
          tags: ${{ vars.DOCKER_USERNAME }}/temp:latest, ${{ vars.DOCKER_USERNAME }}/temp:${{ github.sha }}
          cache-from: type=registry,ref=${{ vars.DOCKER_USERNAME }}/temp:buildcache
          cache-to: type=registry,ref=${{ vars.DOCKER_USERNAME }}/temp:buildcache,mode=max,push=true

      - name: Copy files to VPS
        uses: Burnett01/rsync-deployments@v8
        with:
          switches: -avr --exclude=".git/*" --exclude=".env*" --exclude="backup/"
          path: ./ops/
          remote_host: ${{ secrets.HOSTNAME }}
          remote_user: ${{ secrets.REMOTE_USER }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}
          remote_path: /home/${{ secrets.REMOTE_USER }}/projects/temp/

      - name: Start containers and rollback on failure
        uses: appleboy/ssh-action@v1.2.5
        with:
          host: ${{ secrets.HOSTNAME }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_path: ./scripts/start-or-rollback.sh
          envs: REMOTE_USER,CURRENT_SHA,DOCKER_USERNAME
        env:
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          CURRENT_SHA: ${{ github.sha }}
          DOCKER_USERNAME: ${{ vars.DOCKER_USERNAME }}

  notify:
    name: Notify Discord
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    steps:
      - name: Send Discord Notification
        uses: sarisia/actions-status-discord@v1.16.0
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: ${{ needs.deploy.result != 'failure' && 'success' || 'failure' }}
          title: 'Production Deployment'
          description: |
            **Commit:** ${{ github.event.head_commit.message }}
            **Triggered by:** ${{ github.actor }}
            **Branch:** ${{ github.ref_name }}
            **Repository:** ${{ github.repository }}
          url: '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
          username: GitHub Actions
          avatar_url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png
