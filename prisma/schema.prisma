generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"

  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

enum Provider {
  google
}

enum FileStatus {
  safe
  unsafe
  pending
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  picture   String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  files         File[]
  accounts      Accounts[]
  refreshTokens RefreshToken[]
  subscriptions Subscription[]

  @@map("users")
}

model Accounts {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider   Provider
  providerId String   @map("provider_id")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@index(name: "accounts_user_id_idx", fields: [userId])
  @@map("accounts")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenId   String   @unique @map("token_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index(name: "refresh_tokens_user_id_idx", fields: [userId])
  @@map("refresh_tokens")
}

model File {
  id          String @id @default(uuid())
  description String @db.VarChar(100)
  s3Key       String @unique @map("s3_key")
  name        String @db.VarChar(50)

  contentType String @map("content_type")

  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")
  deletedAt DateTime?  @map("deleted_at")
  expiresAt DateTime   @map("expires_at")
  size      Int
  status    FileStatus @default(pending)

  lastEventAt DateTime? @map("last_event_at")

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  links Link[]

  @@unique(name: "files_name_content_type_unique", [name, userId, contentType])
  @@index(name: "files_user_id_idx", fields: [userId])
  @@index(name: "files_s3_key_idx", fields:[s3Key])
  @@map("files")
}

model Link {
  id String @id @default(uuid())

  shareId String @default(nanoid(13)) @unique @map("share_id")

  clickCount Int @default(0) @map("click_count")

  description String @db.VarChar(100)

  fileId String @map("file_id")
  file   File   @relation(fields: [fileId], references: [id], onDelete: Cascade)

  lastAccessedAt DateTime? @map("last_accessed_at")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  revokedAt DateTime? @map("revoked_at")
  expiresAt DateTime? @map("expires_at")

  password String?

  @@unique(name: "id_file_id_unique", [id, fileId])
  @@index(name: "file_id_idx", fields: [fileId])
  @@map("links")
}

model Subscription {
  id String @id @default(uuid())

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  provider               SubscriptionProvider
  providerSubscriptionId String               @unique @map("provider_subscription_id")
  providerCustomerId     String               @map("provider_customer_id")

  productId String @map("product_id")
  plan      Plan

  amount   Int
  currency String

  interval      BillingInterval @default(month)
  intervalCount Int             @default(1) @map("interval_count")

  status SubscriptionStatus @default(active)

  startedAt          DateTime @map("started_at")
  currentPeriodStart DateTime @map("current_period_start")
  currentPeriodEnd   DateTime @map("current_period_end")

  trialEndsAt DateTime? @map("trial_ends_at")
  cancelledAt DateTime? @map("cancelled_at")
  endedAt     DateTime? @map("ended_at")

  lastEventAt DateTime @map("last_event_at")

  cancelAtPeriodEnd Boolean @default(false) @map("cancel_at_period_end")

  metadata Json?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique(name: "subscriptions_provider_id_user_id_unique", fields: [providerSubscriptionId, userId])
  @@index(name: "subscriptions_user_id_status_idx", fields: [userId,status])
  @@index(name: "subscriptions_provider_subscription_id_idx", fields: [providerSubscriptionId])
  @@index(name: "subscriptions_provider_provider_customer_id_idx", fields: [provider, providerCustomerId])
  @@map("subscriptions")
}

enum SubscriptionProvider {
  polar
}

enum SubscriptionStatus {
  active
  inactive
}

enum Plan {
  free
  pro
}

enum BillingInterval {
  day
  week
  month
  year
}
